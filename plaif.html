<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLAIF - Plan de Vida</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-enter {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .dragging {
            opacity: 0.5;
            background: #4a5568; /* bg-gray-700 */
        }
        /* Estilos para la Matriz PLAIF y SVG */
        #plaif-matrix-view {
            position: relative;
        }
        .plaif-grid {
            display: grid;
            grid-template-columns: 150px repeat(12, minmax(120px, 1fr)); /* Se ajustará con JS */
            position: relative;
            z-index: 1; /* Capa base */
        }
        #plaif-svg-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Permite hacer clic a través del SVG */
            z-index: 2; /* Encima del fondo de la grilla */
        }
        .plaif-header, .plaif-category, .plaif-cell {
            border: 1px solid #4A5568; /* gray-700 */
            padding: 0.5rem;
        }
        .plaif-header, .plaif-category {
            background-color: #2D3748; /* gray-800 */
            font-weight: bold;
            text-align: center;
            position: sticky;
        }
        .plaif-category {
             left: 0;
             z-index: 10;
        }
        .plaif-header {
            top: 0;
            z-index: 20;
        }
        .plaif-cell {
            min-height: 80px;
            background-color: #1A202C; /* gray-900 */
            position: relative;
        }
        .objective-pill {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-block;
            position: relative;
            z-index: 3; /* Encima de las líneas */
        }
        .objective-pill:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <!-- Contenedor Principal -->
    <div id="app" class="container mx-auto p-4 md:p-8">

        <!-- PÁGINA 1: LISTA DE PLANES -->
        <div id="page-plans-list">
            <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-white">PLAIF</h1>
                    <p class="text-gray-400">Tus Planes de Vida</p>
                </div>
                <button id="btn-new-plan" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Nuevo Plan
                </button>
            </header>
            <div id="plans-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Las tarjetas de planes se insertarán aquí -->
            </div>
             <div id="no-plans-message" class="hidden text-center py-16 px-6 bg-gray-800 rounded-lg mt-8">
                <h2 class="text-2xl font-semibold mb-2 text-gray-200">¡Bienvenido a PLAIF!</h2>
                <p class="text-gray-400 mb-6">Parece que aún no tienes ningún plan. ¡Crea el primero para empezar a construir tu futuro!</p>
                <button id="btn-create-first-plan" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-lg">
                    Crear mi primer plan
                </button>
            </div>
        </div>

        <!-- PÁGINA 2: DETALLE DEL PLAN -->
        <div id="page-plan-detail" class="hidden">
            <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <button id="btn-back-to-list" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Volver a Planes
                </button>
                <div class="flex items-center gap-4">
                     <button id="btn-toggle-view" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 shadow-lg">
                        Ver PLAIF
                    </button>
                    <button id="btn-new-objective" class="flex items-center gap-2 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Agregar Objetivo
                    </button>
                </div>
            </header>
            <div class="mb-8">
                <h1 id="detail-plan-name" class="text-4xl font-bold text-white"></h1>
            </div>
            
            <!-- Vista de Lista de Objetivos -->
            <div id="objectives-list-view">
                <p class="text-gray-400 mb-8">Arrastra los objetivos para ordenarlos.</p>
                <div id="objectives-container" class="space-y-4">
                    <!-- Los objetivos se insertarán aquí -->
                </div>
                 <div id="no-objectives-message" class="hidden text-center py-12 px-6 bg-gray-800 rounded-lg mt-8">
                    <h2 class="text-xl font-semibold mb-2 text-gray-300">Sin Objetivos Todavía</h2>
                    <p class="text-gray-400 mb-6">Añade tu primer objetivo para empezar a darle forma a este plan.</p>
                    <button id="btn-create-first-objective" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-5 rounded-lg transition-colors duration-300 shadow-lg">
                        Añadir mi primer objetivo
                    </button>
                </div>
            </div>

            <!-- Vista de Matriz PLAIF -->
            <div id="plaif-matrix-view" class="hidden overflow-x-auto">
                 <div id="plaif-grid-container" class="plaif-grid">
                    <!-- La matriz se generará dinámicamente aquí -->
                </div>
                <svg id="plaif-svg-overlay"></svg>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div id="modal-plan" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden modal-enter">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <h2 id="modal-plan-title" class="text-2xl font-bold mb-6 text-white">Crear Nuevo Plan de Vida</h2>
            <form id="form-plan">
                <div class="mb-4">
                    <label for="plan-name" class="block text-gray-400 mb-2">Nombre del Plan</label>
                    <input id="plan-name" type="text" required class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500" placeholder="Ej: Mi desarrollo profesional 2025">
                </div>
                <div class="flex gap-4 mb-6">
                    <div class="flex-grow">
                        <label for="plan-duration" class="block text-gray-400 mb-2">Duración</label>
                        <input id="plan-duration" type="number" min="1" required class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500" value="1">
                    </div>
                    <div>
                        <label for="plan-unit" class="block text-gray-400 mb-2">Unidad</label>
                        <select id="plan-unit" class="w-full bg-gray-700 text-white p-2 rounded-md border h-[42px] border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            <option value="días">Días</option>
                            <option value="semanas">Semanas</option>
                            <option value="meses" selected>Meses</option>
                            <option value="años">Años</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" class="btn-cancel-modal py-2 px-4 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">Cancelar</button>
                    <button type="submit" class="py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-md transition-colors">Guardar Plan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="modal-objective" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden modal-enter">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <h2 id="modal-objective-title" class="text-2xl font-bold mb-6 text-white">Agregar Nuevo Objetivo</h2>
            <form id="form-objective">
                <input type="hidden" id="objective-id">
                <div class="mb-4">
                    <label for="objective-title" class="block text-gray-400 mb-2">Título del Objetivo</label>
                    <input id="objective-title" type="text" required class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500" placeholder="Ej: Aprender una nueva habilidad">
                </div>
                <div class="mb-4">
                    <label for="objective-description" class="block text-gray-400 mb-2">Descripción</label>
                    <textarea id="objective-description" rows="3" required class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500" placeholder="Ej: Completar un curso y construir una aplicación"></textarea>
                </div>
                 <div class="flex gap-4 mb-6">
                    <div class="flex-grow">
                        <label for="objective-category" class="block text-gray-400 mb-2">Categoría</label>
                        <select id="objective-category" class="w-full bg-gray-700 text-white p-2 rounded-md border h-[42px] border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            <option>amor</option>
                            <option>salud</option>
                            <option>espiritualidad</option>
                            <option>finanzas</option>
                            <option selected>crecimiento personal</option>
                            <option>recreacion</option>
                            <option>legado</option>
                        </select>
                    </div>
                    <div>
                        <label id="objective-time-label" for="objective-time-unit" class="block text-gray-400 mb-2">Mes</label>
                        <input id="objective-time-unit" type="number" min="1" required class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500" value="1">
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" class="btn-cancel-modal py-2 px-4 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">Cancelar</button>
                    <button type="submit" class="py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-md transition-colors">Guardar Objetivo</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-confirm" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden modal-enter">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-sm m-4">
            <h2 class="text-xl font-bold mb-4 text-white">Confirmar Eliminación</h2>
            <p id="confirm-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end gap-4">
                <button type="button" id="btn-cancel-confirm" class="py-2 px-4 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">Cancelar</button>
                <button type="button" id="btn-do-confirm" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-md transition-colors">Eliminar</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- ESTADO DE LA APLICACIÓN ---
            let state = {
                currentPage: 'plans-list',
                isMatrixView: false,
                plans: [],
                objectives: [],
                currentPlanId: null,
                editingPlanId: null,
                editingObjectiveId: null,
                confirmAction: null
            };

            const CATEGORIES_ORDER = ['espiritualidad', 'legado', 'amor', 'recreacion', 'crecimiento personal', 'finanzas', 'salud'];
            const CATEGORY_STYLES = {
                amor: "bg-pink-800 text-pink-200",
                salud: "bg-green-800 text-green-200",
                espiritualidad: "bg-purple-800 text-purple-200",
                finanzas: "bg-blue-800 text-blue-200",
                'crecimiento personal': "bg-yellow-800 text-yellow-200",
                recreacion: "bg-teal-800 text-teal-200",
                legado: "bg-indigo-800 text-indigo-200",
            };

            // --- ELEMENTOS DEL DOM ---
            const pagePlansList = document.getElementById('page-plans-list');
            const pagePlanDetail = document.getElementById('page-plan-detail');
            const objectivesListView = document.getElementById('objectives-list-view');
            const plaifMatrixView = document.getElementById('plaif-matrix-view');
            const plansContainer = document.getElementById('plans-container');
            const objectivesContainer = document.getElementById('objectives-container');
            const plaifGridContainer = document.getElementById('plaif-grid-container');
            const svgOverlay = document.getElementById('plaif-svg-overlay');
            const detailPlanName = document.getElementById('detail-plan-name');
            const btnToggleView = document.getElementById('btn-toggle-view');
            
            // Modales y Formularios
            const modalPlan = document.getElementById('modal-plan');
            const modalObjective = document.getElementById('modal-objective');
            const modalConfirm = document.getElementById('modal-confirm');
            const formPlan = document.getElementById('form-plan');
            const formObjective = document.getElementById('form-objective');
            const confirmMessage = document.getElementById('confirm-message');
            const btnDoConfirm = document.getElementById('btn-do-confirm');

            // --- LÓGICA DE ALMACENAMIENTO ---
            const getFromStorage = (key) => JSON.parse(localStorage.getItem(key)) || [];
            const saveToStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));
            const loadState = () => {
                state.plans = getFromStorage('plaif_plans');
                state.objectives = getFromStorage('plaif_objectives');
            };
            const saveState = () => {
                saveToStorage('plaif_plans', state.plans);
                saveToStorage('plaif_objectives', state.objectives);
            };

            // --- LÓGICA DE RENDERIZADO ---
            const render = () => {
                if (state.currentPage === 'plans-list') {
                    renderPlansListPage();
                } else if (state.currentPage === 'plan-detail') {
                    renderPlanDetailPage();
                }
            };

            const renderPlansListPage = () => {
                pagePlansList.classList.remove('hidden');
                pagePlanDetail.classList.add('hidden');
                plansContainer.innerHTML = '';
                const noPlansMessage = document.getElementById('no-plans-message');
                if(state.plans.length === 0) {
                   noPlansMessage.classList.remove('hidden');
                } else {
                   noPlansMessage.classList.add('hidden');
                }
                state.plans.forEach(plan => {
                    const card = document.createElement('div');
                    card.className = "bg-gray-800 p-6 rounded-lg cursor-pointer hover:bg-gray-700 hover:scale-105 transition-all duration-300 shadow-md";
                    card.innerHTML = `<h3 class="text-xl font-bold text-white">${plan.name}</h3><p class="text-gray-400 mt-2">Duración: ${plan.duration} ${plan.unit}</p>`;
                    card.addEventListener('click', () => navigateToDetail(plan.id));
                    plansContainer.appendChild(card);
                });
            };

            const renderPlanDetailPage = () => {
                pagePlansList.classList.add('hidden');
                pagePlanDetail.classList.remove('hidden');
                
                const plan = state.plans.find(p => p.id === state.currentPlanId);
                if (!plan) { navigateToList(); return; }

                detailPlanName.textContent = plan.name;
                
                if (state.isMatrixView) {
                    objectivesListView.classList.add('hidden');
                    plaifMatrixView.classList.remove('hidden');
                    btnToggleView.textContent = "Ver Lista";
                    renderPlaifMatrix(plan);
                } else {
                    objectivesListView.classList.remove('hidden');
                    plaifMatrixView.classList.add('hidden');
                    btnToggleView.textContent = "Ver PLAIF";
                    renderObjectivesList(plan);
                }
            };
            
            const renderObjectivesList = (plan) => {
                objectivesContainer.innerHTML = '';
                const planObjectives = state.objectives
                    .filter(obj => obj.planId === plan.id)
                    .sort((a, b) => a.order - b.order);

                const noObjectivesMessage = document.getElementById('no-objectives-message');
                 if(planObjectives.length === 0) {
                   noObjectivesMessage.classList.remove('hidden');
                } else {
                   noObjectivesMessage.classList.add('hidden');
                }

                planObjectives.forEach((obj, index) => {
                    const objectiveCard = document.createElement('div');
                    objectiveCard.className = "flex items-start gap-4 p-4 bg-gray-800 rounded-lg transition-all duration-300 cursor-grab active:cursor-grabbing";
                    objectiveCard.setAttribute('draggable', true);
                    objectiveCard.dataset.id = obj.id;
                    objectiveCard.dataset.index = index;
                    const categoryClass = CATEGORY_STYLES[obj.category.toLowerCase()] || 'bg-gray-600';
                    objectiveCard.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 mt-1 flex-shrink-0"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h3 class="text-lg font-semibold text-gray-200">${obj.title}</h3>
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${categoryClass}">${obj.category}</span>
                            </div>
                            <p class="text-gray-400 mt-1">${obj.description}</p>
                            <p class="text-xs text-gray-500 mt-2">${plan.unit.slice(0, -1)}: ${obj.timeUnitValue}</p>
                        </div>
                        <div class="flex flex-col gap-2 flex-shrink-0">
                            <button class="btn-edit-objective p-1 text-gray-400 hover:text-yellow-400 transition-colors" data-id="${obj.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button class="btn-delete-objective p-1 text-gray-400 hover:text-red-500 transition-colors" data-id="${obj.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>
                    `;
                    objectivesContainer.appendChild(objectiveCard);
                });
            };

            const renderPlaifMatrix = (plan) => {
                plaifGridContainer.innerHTML = '';
                svgOverlay.innerHTML = '';
                plaifGridContainer.style.gridTemplateColumns = `150px repeat(${plan.duration}, minmax(120px, 1fr))`;
                
                plaifGridContainer.innerHTML += `<div class="plaif-header"></div>`;
                for (let i = 1; i <= plan.duration; i++) {
                    const unitLabel = plan.unit.charAt(0).toUpperCase() + plan.unit.slice(1,-1);
                    plaifGridContainer.innerHTML += `<div class="plaif-header">${unitLabel} ${i}</div>`;
                }
                CATEGORIES_ORDER.slice().reverse().forEach(category => {
                    const categoryLabel = category.charAt(0).toUpperCase() + category.slice(1);
                    let rowHtml = `<div class="plaif-category">${categoryLabel}</div>`;
                    for(let i = 1; i <= plan.duration; i++){
                        const objectivesInCell = state.objectives.filter(obj => 
                            obj.planId === plan.id && obj.category === category && obj.timeUnitValue === i);
                        let objectivesHtml = objectivesInCell.map(obj => {
                            const categoryClass = CATEGORY_STYLES[obj.category.toLowerCase()] || 'bg-gray-600';
                            return `<div class="objective-pill ${categoryClass}" data-id="${obj.id}">${obj.title}</div>`;
                        }).join('');
                        rowHtml += `<div class="plaif-cell">${objectivesHtml}</div>`;
                    }
                    plaifGridContainer.innerHTML += rowHtml;
                });

                setTimeout(() => drawConnectionLines(plan), 50); // Increased timeout slightly
            };

            const drawConnectionLines = (plan) => {
                svgOverlay.innerHTML = '';
                const sortedObjectives = state.objectives
                    .filter(obj => obj.planId === plan.id)
                    .sort((a, b) => a.order - b.order);

                if (sortedObjectives.length < 2) return;

                const matrixRect = plaifMatrixView.getBoundingClientRect();
                
                for(let i = 1; i < sortedObjectives.length; i++) {
                    const prevObj = sortedObjectives[i - 1];
                    const currentObj = sortedObjectives[i];
                    
                    const prevPill = document.querySelector(`.objective-pill[data-id="${prevObj.id}"]`);
                    const currentPill = document.querySelector(`.objective-pill[data-id="${currentObj.id}"]`);
                    
                    if(prevPill && currentPill) {
                        const prevRect = prevPill.getBoundingClientRect();
                        const currentRect = currentPill.getBoundingClientRect();
                        
                        // Calculate coordinates relative to the matrix view container
                        const x1 = prevRect.left + prevRect.width / 2 - matrixRect.left + plaifMatrixView.scrollLeft;
                        const y1 = prevRect.top + prevRect.height / 2 - matrixRect.top + plaifMatrixView.scrollTop;
                        const x2 = currentRect.left + currentRect.width / 2 - matrixRect.left + plaifMatrixView.scrollLeft;
                        const y2 = currentRect.top + currentRect.height / 2 - matrixRect.top + plaifMatrixView.scrollTop;
                        
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', x1);
                        line.setAttribute('y1', y1);
                        line.setAttribute('x2', x2);
                        line.setAttribute('y2', y2);
                        line.setAttribute('stroke', 'rgba(156, 163, 175, 0.5)'); // gray-400 with opacity
                        line.setAttribute('stroke-width', '2');
                        line.setAttribute('stroke-dasharray', '5,5');
                        svgOverlay.appendChild(line);
                    }
                }
                 // Match SVG size to the scrollable content size of the grid
                svgOverlay.setAttribute('width', plaifGridContainer.scrollWidth);
                svgOverlay.setAttribute('height', plaifGridContainer.scrollHeight);
            };


            // --- LÓGICA DE NAVEGACIÓN Y MODALES ---
            const navigateToDetail = (planId) => {
                state.currentPlanId = planId;
                state.isMatrixView = false;
                state.currentPage = 'plan-detail';
                render();
            };
            const navigateToList = () => {
                state.currentPlanId = null;
                state.currentPage = 'plans-list';
                render();
            };
            const openModal = (modalElement) => modalElement.classList.remove('hidden');
            const closeModal = (modalElement) => modalElement.classList.add('hidden');

            const openObjectiveModal = (objectiveId = null) => {
                formObjective.reset();
                state.editingObjectiveId = objectiveId;
                const modalTitle = document.getElementById('modal-objective-title');
                const timeLabel = document.getElementById('objective-time-label');
                const timeInput = document.getElementById('objective-time-unit');
                const plan = state.plans.find(p => p.id === state.currentPlanId);
                
                const unitLabel = plan.unit.charAt(0).toUpperCase() + plan.unit.slice(1, -1);
                timeLabel.textContent = unitLabel;
                timeInput.setAttribute('max', plan.duration);

                if (objectiveId) {
                    modalTitle.textContent = "Editar Objetivo";
                    const objective = state.objectives.find(o => o.id === objectiveId);
                    document.getElementById('objective-title').value = objective.title;
                    document.getElementById('objective-description').value = objective.description;
                    document.getElementById('objective-category').value = objective.category;
                    timeInput.value = objective.timeUnitValue;
                } else {
                     modalTitle.textContent = "Agregar Nuevo Objetivo";
                }
                openModal(modalObjective);
            }
            
            const openConfirmModal = (message, onConfirm) => {
                confirmMessage.textContent = message;
                state.confirmAction = onConfirm;
                openModal(modalConfirm);
            };

            // --- EVENT LISTENERS ---
            document.getElementById('btn-new-plan').addEventListener('click', () => openModal(modalPlan));
            document.getElementById('btn-create-first-plan').addEventListener('click', () => openModal(modalPlan));
            document.getElementById('btn-new-objective').addEventListener('click', () => openObjectiveModal());
            document.getElementById('btn-create-first-objective').addEventListener('click', () => openObjectiveModal());
            document.getElementById('btn-back-to-list').addEventListener('click', navigateToList);
            btnToggleView.addEventListener('click', () => {
                state.isMatrixView = !state.isMatrixView;
                render();
            });

            document.querySelectorAll('.btn-cancel-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    closeModal(modalPlan);
                    closeModal(modalObjective);
                });
            });

            formPlan.addEventListener('submit', (e) => {
                e.preventDefault();
                const planData = {
                    id: state.editingPlanId || Date.now().toString(),
                    name: document.getElementById('plan-name').value.trim(),
                    duration: parseInt(document.getElementById('plan-duration').value, 10),
                    unit: document.getElementById('plan-unit').value
                };
                if (!state.editingPlanId) state.plans.push(planData);
                else state.plans = state.plans.map(p => p.id === state.editingPlanId ? planData : p);
                state.editingPlanId = null;
                saveState(); render(); closeModal(modalPlan);
            });

            formObjective.addEventListener('submit', (e) => {
                e.preventDefault();
                const currentObjectives = state.objectives.filter(o => o.planId === state.currentPlanId);
                const objectiveData = {
                    id: state.editingObjectiveId || Date.now().toString(),
                    planId: state.currentPlanId,
                    title: document.getElementById('objective-title').value.trim(),
                    description: document.getElementById('objective-description').value.trim(),
                    category: document.getElementById('objective-category').value,
                    timeUnitValue: parseInt(document.getElementById('objective-time-unit').value, 10),
                    order: state.editingObjectiveId ? state.objectives.find(o=>o.id === state.editingObjectiveId).order : currentObjectives.length
                };
                if (state.editingObjectiveId) {
                    state.objectives = state.objectives.map(o => o.id === state.editingObjectiveId ? objectiveData : o);
                } else {
                    state.objectives.push(objectiveData);
                }
                state.editingObjectiveId = null;
                saveState(); render(); closeModal(modalObjective);
            });

            objectivesContainer.addEventListener('click', (e) => {
                const editButton = e.target.closest('.btn-edit-objective');
                const deleteButton = e.target.closest('.btn-delete-objective');
                if (editButton) openObjectiveModal(editButton.dataset.id);
                if (deleteButton) {
                    const objectiveId = deleteButton.dataset.id;
                    const objective = state.objectives.find(o => o.id === objectiveId);
                    openConfirmModal(`¿Estás seguro de que quieres eliminar "${objective.title}"?`, () => {
                        state.objectives = state.objectives.filter(o => o.id !== objectiveId);
                        const remaining = state.objectives.filter(o => o.planId === state.currentPlanId).sort((a,b) => a.order - b.order);
                        remaining.forEach((o, index) => {
                           const originalObj = state.objectives.find(s_o => s_o.id === o.id);
                           if(originalObj) originalObj.order = index;
                        });
                        saveState(); render();
                    });
                }
            });
            
            plaifGridContainer.addEventListener('click', (e) => {
                 const pill = e.target.closest('.objective-pill');
                 if(pill) openObjectiveModal(pill.dataset.id);
            });

            document.getElementById('btn-cancel-confirm').addEventListener('click', () => closeModal(modalConfirm));
            btnDoConfirm.addEventListener('click', () => {
                if(typeof state.confirmAction === 'function') state.confirmAction();
                state.confirmAction = null;
                closeModal(modalConfirm);
            });

            // --- DRAG & DROP ---
            let draggedElement = null;
            objectivesContainer.addEventListener('dragstart', e => {
                if (e.target.draggable) {
                    draggedElement = e.target;
                    setTimeout(() => draggedElement.classList.add('dragging'), 0);
                }
            });
            objectivesContainer.addEventListener('dragend', () => { if(draggedElement) draggedElement.classList.remove('dragging'); draggedElement = null; });
            objectivesContainer.addEventListener('dragover', e => {
                e.preventDefault();
                const target = e.target.closest('[draggable="true"]');
                if (target && target !== draggedElement) {
                   const rect = target.getBoundingClientRect();
                   const nextSibling = (e.clientY - rect.top) / rect.height > 0.5 ? target.nextSibling : target;
                   objectivesContainer.insertBefore(draggedElement, nextSibling);
                }
            });
            objectivesContainer.addEventListener('drop', e => {
                e.preventDefault();
                if(draggedElement){
                    const newOrderIds = Array.from(objectivesContainer.querySelectorAll('[data-id]')).map(el => el.dataset.id);
                    newOrderIds.forEach((id, index) => {
                        const objective = state.objectives.find(o => o.id === id);
                        if(objective) objective.order = index;
                    });
                    saveState(); render();
                }
            });
            
            window.addEventListener('resize', () => {
                if(state.currentPage === 'plan-detail' && state.isMatrixView) {
                    const plan = state.plans.find(p => p.id === state.currentPlanId);
                    if(plan) drawConnectionLines(plan);
                }
            });
            
            loadState(); render();
        });
    </script>
</body>
</html>
