<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLAIF - Plan de Vida</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-enter {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .dragging {
            opacity: 0.5;
            background: #4a5568; /* bg-gray-700 */
        }
        #plaif-matrix-view {
            position: relative;
        }
        .plaif-grid {
            display: grid;
            grid-template-columns: 150px repeat(12, minmax(120px, 1fr)); /* Se ajustará con JS */
            position: relative;
            z-index: 1; 
        }
        #plaif-svg-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; 
            z-index: 2;
        }
        .plaif-header, .plaif-category, .plaif-cell {
            border: 1px solid #4A5568; padding: 0.5rem;
        }
        .plaif-header, .plaif-category {
            background-color: #2D3748; font-weight: bold; text-align: center; position: sticky;
        }
        .plaif-category { left: 0; z-index: 10; }
        .plaif-header { top: 0; z-index: 20; }
        .plaif-cell { min-height: 80px; background-color: #1A202C; position: relative; }
        .objective-pill {
            padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.8rem; margin-bottom: 0.25rem;
            cursor: pointer; transition: transform 0.2s; display: inline-block; position: relative; z-index: 3;
        }
        .objective-pill:hover { transform: scale(1.05); }
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #fff;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .view-btn {
             padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: bold; transition: background-color 0.2s;
        }
        .view-btn.active {
            background-color: #4A5568; /* gray-700 */
        }
        .view-btn:not(.active) {
            background-color: #2D3748; /* gray-800 */
        }
         .view-btn:not(.active):hover {
            background-color: #4A5568;
        }
        .score-btn {
            background-color: #4A5568; /* gray-700 */
            border: 2px solid transparent;
        }
        .score-btn.selected {
            border-color: #A78BFA; /* purple-400 */
            background-color: #5B21B6; /* purple-700 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div id="app" class="container mx-auto p-4 md:p-8">
        <!-- PÁGINA 1: LISTA DE PLANES -->
        <div id="page-plans-list">
            <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-white">PLAIF</h1>
                    <p class="text-gray-400">Tus Planes de Vida, Potenciados con IA</p>
                </div>
                <button id="btn-new-plan" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Nuevo Plan
                </button>
            </header>
            <div id="plans-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
             <div id="no-plans-message" class="hidden text-center py-16 px-6 bg-gray-800 rounded-lg mt-8">
                <h2 class="text-2xl font-semibold mb-2 text-gray-200">¡Bienvenido a PLAIF!</h2>
                <p class="text-gray-400 mb-6">Parece que aún no tienes ningún plan. ¡Crea el primero para empezar a construir tu futuro!</p>
                <button id="btn-create-first-plan" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-lg">
                    Crear mi primer plan
                </button>
            </div>
        </div>

        <!-- PÁGINA 2: DETALLE DEL PLAN (OBJETIVOS Y GRÁFICAS) -->
        <div id="page-plan-detail" class="hidden">
            <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <button id="btn-back-to-list-from-detail" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Planes
                </button>
                <div class="flex items-center gap-2 bg-gray-800 p-1 rounded-lg">
                    <button id="btn-view-list" class="view-btn">Lista</button>
                    <button id="btn-view-matrix" class="view-btn">Matriz</button>
                    <button id="btn-view-radar" class="view-btn">Radar</button>
                </div>
                <div class="flex items-center gap-4">
                    <button id="btn-edit-visualization" title="Editar Visualización" class="p-2 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>
                    <button id="btn-suggest-objectives" title="Sugerir Objetivos con IA" class="flex items-center gap-2 bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 shadow-lg">✨ Sugerir</button>
                    <button id="btn-new-objective" class="flex items-center gap-2 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 shadow-lg"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Agregar</button>
                </div>
            </header>
            <div class="mb-8"><h1 id="detail-plan-name" class="text-4xl font-bold text-white"></h1></div>
            
            <div id="objectives-list-view"><p class="text-gray-400 mb-8">Arrastra los objetivos para ordenarlos.</p><div id="objectives-container" class="space-y-4"></div><div id="no-objectives-message" class="hidden text-center py-12 px-6 bg-gray-800 rounded-lg mt-8"><h2 class="text-xl font-semibold mb-2 text-gray-300">Sin Objetivos Todavía</h2><p class="text-gray-400 mb-6">Añade tu primer objetivo para empezar a darle forma a este plan.</p><button id="btn-create-first-objective" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-5 rounded-lg transition-colors duration-300 shadow-lg">Añadir mi primer objetivo</button></div></div>
            <div id="plaif-matrix-view" class="hidden overflow-x-auto"><div id="plaif-grid-container" class="plaif-grid"></div><svg id="plaif-svg-overlay"></svg></div>
            <div id="radar-chart-view" class="hidden p-4 md:p-8 bg-gray-800 rounded-lg"><canvas id="radar-chart-canvas"></canvas></div>
        </div>

        <!-- PÁGINA 3: FORMULARIO DE VISUALIZACIÓN -->
        <div id="page-visualization" class="hidden">
            <h1 id="viz-plan-name" class="text-3xl font-bold text-white mb-2">Visualización del Plan</h1>
            <p class="text-gray-400 mb-8">Antes de definir objetivos, visualiza el éxito. ¿Cómo te ves al final de este periodo en cada área de tu vida? Describe esa visión y qué emoción te genera.</p>
            <form id="form-visualization" class="space-y-6">
                <div id="viz-categories-container" class="space-y-6"></div>
                <div class="pt-6 border-t border-gray-700 flex justify-end">
                    <button type="submit" class="w-full md:w-auto bg-purple-700 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-lg">Guardar Visualización y Continuar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODALES -->
    <div id="modal-plan" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden modal-enter">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <h2 id="modal-plan-title" class="text-2xl font-bold mb-6 text-white">Crear Nuevo Plan de Vida</h2>
            <form id="form-plan"><div class="mb-4"><label for="plan-name" class="block text-gray-400 mb-2">Nombre del Plan</label><input id="plan-name" type="text" required class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500" placeholder="Ej: Mi desarrollo profesional 2025"></div><div class="flex gap-4 mb-6"><div class="flex-grow"><label for="plan-duration" class="block text-gray-400 mb-2">Duración</label><input id="plan-duration" type="number" min="1" required class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500" value="1"></div><div><label for="plan-unit" class="block text-gray-400 mb-2">Unidad</label><select id="plan-unit" class="w-full bg-gray-700 text-white p-2 rounded-md border h-[42px] border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500"><option value="días">Días</option><option value="semanas">Semanas</option><option value="meses" selected>Meses</option><option value="años">Años</option></select></div></div><div class="flex justify-end gap-4"><button type="button" class="btn-cancel-modal py-2 px-4 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">Cancelar</button><button type="submit" class="py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-md transition-colors">Guardar Plan</button></div></form>
        </div>
    </div>
    <div id="modal-objective" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden modal-enter">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <h2 id="modal-objective-title" class="text-2xl font-bold mb-6 text-white">Agregar Nuevo Objetivo</h2>
            <form id="form-objective"><input type="hidden" id="objective-id"><div class="mb-4"><label for="objective-title" class="block text-gray-400 mb-2">Título del Objetivo</label><div class="flex items-center gap-2"><input id="objective-title" type="text" required class="flex-grow w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500" placeholder="Ej: Aprender una nueva habilidad"><button id="btn-deconstruct-objective" type="button" title="Desglosar objetivo con IA" class="p-2 bg-purple-700 hover:bg-purple-600 rounded-md text-white transition-colors">✨</button></div></div><div class="mb-4"><label for="objective-description" class="block text-gray-400 mb-2">Descripción</label><textarea id="objective-description" rows="4" required class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500" placeholder="Ej: Completar un curso y construir una aplicación"></textarea></div><div class="flex gap-4 mb-6"><div class="flex-grow"><label for="objective-category" class="block text-gray-400 mb-2">Categoría</label><select id="objective-category" class="w-full bg-gray-700 text-white p-2 rounded-md border h-[42px] border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500"><option>amor</option><option>salud</option><option>espiritualidad</option><option>finanzas</option><option selected>crecimiento personal</option><option>recreacion</option><option>legado</option></select></div><div><label id="objective-time-label" for="objective-time-unit" class="block text-gray-400 mb-2">Mes</label><input id="objective-time-unit" type="number" min="1" required class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500" value="1"></div></div><div class="flex justify-end gap-4"><button type="button" class="btn-cancel-modal py-2 px-4 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">Cancelar</button><button type="submit" class="py-2 px-4 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-md transition-colors">Guardar Objetivo</button></div></form>
        </div>
    </div>
    <div id="modal-suggestions" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden modal-enter"><div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-lg m-4"><h2 class="text-2xl font-bold mb-4 text-white">✨ Sugerencias de Objetivos</h2><p class="text-gray-400 mb-6">Aquí hay algunas ideas generadas por IA para tu plan. Haz clic en "Agregar" para añadirlas.</p><div id="suggestions-content" class="space-y-3"></div><div class="flex justify-end mt-6"><button type="button" class="btn-cancel-modal py-2 px-4 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">Cerrar</button></div></div></div>
    <div id="modal-confirm" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden modal-enter"><div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-full max-w-sm m-4"><h2 class="text-xl font-bold mb-4 text-white">Confirmar Eliminación</h2><p id="confirm-message" class="text-gray-300 mb-6"></p><div class="flex justify-end gap-4"><button type="button" id="btn-cancel-confirm" class="py-2 px-4 text-gray-300 hover:bg-gray-700 rounded-md transition-colors">Cancelar</button><button type="button" id="btn-do-confirm" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-md transition-colors">Eliminar</button></div></div></div>
    <div id="loader-overlay" class="loader-overlay hidden"><div class="spinner"></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let state = { currentPage: 'plans-list', detailViewMode: 'list', plans: [], objectives: [], visualizations: [], currentPlanId: null, editingPlanId: null, editingObjectiveId: null, confirmAction: null };
            let radarChartInstance = null;
            const CATEGORIES_ORDER = ['espiritualidad', 'legado', 'amor', 'recreacion', 'crecimiento personal', 'finanzas', 'salud'];
            const CATEGORY_STYLES = { amor: "bg-pink-800 text-pink-200", salud: "bg-green-800 text-green-200", espiritualidad: "bg-purple-800 text-purple-200", finanzas: "bg-blue-800 text-blue-200", 'crecimiento personal': "bg-yellow-800 text-yellow-200", recreacion: "bg-teal-800 text-teal-200", legado: "bg-indigo-800 text-indigo-200" };
            const DOM = {
                pagePlansList: document.getElementById('page-plans-list'), pagePlanDetail: document.getElementById('page-plan-detail'), pageVisualization: document.getElementById('page-visualization'),
                vizPlanName: document.getElementById('viz-plan-name'), vizCategoriesContainer: document.getElementById('viz-categories-container'),
                formVisualization: document.getElementById('form-visualization'),
                objectivesListView: document.getElementById('objectives-list-view'), plaifMatrixView: document.getElementById('plaif-matrix-view'),
                radarChartView: document.getElementById('radar-chart-view'), plansContainer: document.getElementById('plans-container'),
                objectivesContainer: document.getElementById('objectives-container'), plaifGridContainer: document.getElementById('plaif-grid-container'),
                svgOverlay: document.getElementById('plaif-svg-overlay'), detailPlanName: document.getElementById('detail-plan-name'),
                loaderOverlay: document.getElementById('loader-overlay'), modalPlan: document.getElementById('modal-plan'),
                modalObjective: document.getElementById('modal-objective'), modalConfirm: document.getElementById('modal-confirm'),
                modalSuggestions: document.getElementById('modal-suggestions'), suggestionsContent: document.getElementById('suggestions-content'),
                formPlan: document.getElementById('form-plan'), formObjective: document.getElementById('form-objective'),
                confirmMessage: document.getElementById('confirm-message'), btnDoConfirm: document.getElementById('btn-do-confirm'),
                btnViewList: document.getElementById('btn-view-list'), btnViewMatrix: document.getElementById('btn-view-matrix'),
                btnViewRadar: document.getElementById('btn-view-radar'), btnEditVisualization: document.getElementById('btn-edit-visualization')
            };
            const getFromStorage = (key) => JSON.parse(localStorage.getItem(key)) || [];
            const saveToStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));
            const loadState = () => { state.plans = getFromStorage('plaif_plans'); state.objectives = getFromStorage('plaif_objectives'); state.visualizations = getFromStorage('plaif_visualizations');};
            const saveState = () => { saveToStorage('plaif_plans', state.plans); saveToStorage('plaif_objectives', state.objectives); saveToStorage('plaif_visualizations', state.visualizations); };

            const callGemini = async (prompt) => {
                DOM.loaderOverlay.classList.remove('hidden');
                const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { const errorBody = await response.json(); throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody.error.message}`); }
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]) { return result.candidates[0].content.parts[0].text; } 
                    else { throw new Error("Respuesta de la API inesperada o vacía."); }
                } catch (error) { console.error("Error llamando a la API de Gemini:", error); alert(`Error de IA: ${error.message}`); return null; } 
                finally { DOM.loaderOverlay.classList.add('hidden'); }
            };

            const render = () => {
                const pages = { 'plans-list': DOM.pagePlansList, 'plan-detail': DOM.pagePlanDetail, 'visualization': DOM.pageVisualization };
                Object.values(pages).forEach(page => page.classList.add('hidden'));
                if (pages[state.currentPage]) {
                    pages[state.currentPage].classList.remove('hidden');
                }

                if (state.currentPage === 'plans-list') renderPlansListPage();
                else if (state.currentPage === 'plan-detail') renderPlanDetailPage();
                else if (state.currentPage === 'visualization') renderVisualizationPage();
            };

            const renderPlansListPage = () => {
                DOM.plansContainer.innerHTML = ''; const noPlansMessage = document.getElementById('no-plans-message');
                if (state.plans.length === 0) noPlansMessage.classList.remove('hidden'); else noPlansMessage.classList.add('hidden');
                state.plans.forEach(plan => {
                    const card = document.createElement('div');
                    card.className = "bg-gray-800 p-6 rounded-lg cursor-pointer hover:bg-gray-700 hover:scale-105 transition-all duration-300 shadow-md";
                    card.innerHTML = `<h3 class="text-xl font-bold text-white">${plan.name}</h3><p class="text-gray-400 mt-2">Duración: ${plan.duration} ${plan.unit}</p>`;
                    card.addEventListener('click', () => navigateToPlan(plan.id));
                    DOM.plansContainer.appendChild(card);
                });
            };

            const renderPlanDetailPage = () => {
                const plan = state.plans.find(p => p.id === state.currentPlanId);
                if (!plan) { navigateToList(); return; }
                DOM.detailPlanName.textContent = plan.name;
                const views = { list: DOM.objectivesListView, matrix: DOM.plaifMatrixView, radar: DOM.radarChartView };
                const viewBtns = { list: DOM.btnViewList, matrix: DOM.btnViewMatrix, radar: DOM.btnViewRadar };
                Object.keys(views).forEach(key => { views[key].classList.add('hidden'); viewBtns[key].classList.remove('active'); });
                views[state.detailViewMode].classList.remove('hidden'); viewBtns[state.detailViewMode].classList.add('active');
                if (state.detailViewMode === 'list') renderObjectivesList(plan);
                else if (state.detailViewMode === 'matrix') renderPlaifMatrix(plan);
                else if (state.detailViewMode === 'radar') renderRadarChart(plan);
            };
            
            const renderVisualizationPage = () => {
                const plan = state.plans.find(p => p.id === state.currentPlanId);
                if (!plan) { navigateToList(); return; }
                DOM.vizPlanName.textContent = `Visualización para "${plan.name}"`;
                DOM.vizCategoriesContainer.innerHTML = '';
                const existingViz = state.visualizations.find(v => v.planId === plan.id);

                CATEGORIES_ORDER.forEach(category => {
                    const categoryId = category.replace(/\s+/g, '-'); // Create a valid ID
                    const vizData = existingViz?.categories[category] || { description: '', score: 0 };
                    const categoryEl = document.createElement('div');
                    categoryEl.className = 'bg-gray-800 p-4 rounded-lg';
                    categoryEl.innerHTML = `
                        <label for="viz-desc-${categoryId}" class="block text-lg font-bold text-purple-300 mb-2 capitalize">${category}</label>
                        <textarea id="viz-desc-${categoryId}" data-category="${category}" class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="3" placeholder="Describe cómo te ves en esta área...">${vizData.description}</textarea>
                        <div class="mt-3">
                            <p class="text-sm text-gray-400 mb-2">Esta visión me genera:</p>
                            <div class="flex items-center gap-3" data-category="${category}">
                                <button type="button" data-score="-1" class="score-btn p-2 rounded-full ${vizData.score === -1 ? 'selected' : ''}" title="Ansiedad"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M16 16s-1.5-2-4-2-4 2-4 2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg></button>
                                <button type="button" data-score="0" class="score-btn p-2 rounded-full ${vizData.score === 0 ? 'selected' : ''}" title="Indiferencia"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="15" x2="16" y2="15"></line><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg></button>
                                <button type="button" data-score="1" class="score-btn p-2 rounded-full ${vizData.score === 1 ? 'selected' : ''}" title="Motivación"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg></button>
                            </div>
                        </div>
                    `;
                    DOM.vizCategoriesContainer.appendChild(categoryEl);
                });
            };
            
            const renderObjectivesList = (plan) => {
                DOM.objectivesContainer.innerHTML = ''; const planObjectives = state.objectives.filter(obj => obj.planId === plan.id).sort((a, b) => a.order - b.order);
                const noObjectivesMessage = document.getElementById('no-objectives-message');
                if(planObjectives.length === 0) noObjectivesMessage.classList.remove('hidden'); else noObjectivesMessage.classList.add('hidden');
                planObjectives.forEach((obj, index) => {
                    const card = document.createElement('div'); card.className = "flex items-start gap-4 p-4 bg-gray-800 rounded-lg transition-all duration-300 cursor-grab active:cursor-grabbing";
                    card.draggable = true; card.dataset.id = obj.id; card.dataset.index = index;
                    const categoryClass = CATEGORY_STYLES[obj.category.toLowerCase()] || 'bg-gray-600';
                    card.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 mt-1 flex-shrink-0"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg><div class="flex-grow"><div class="flex justify-between items-start"><h3 class="text-lg font-semibold text-gray-200">${obj.title}</h3><span class="text-xs font-semibold px-2 py-1 rounded-full ${categoryClass}">${obj.category}</span></div><p class="text-gray-400 mt-1">${obj.description}</p><p class="text-xs text-gray-500 mt-2">${plan.unit.slice(0, -1)}: ${obj.timeUnitValue}</p></div><div class="flex flex-col gap-2 flex-shrink-0"><button class="btn-edit-objective p-1 text-gray-400 hover:text-yellow-400 transition-colors" data-id="${obj.id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="btn-delete-objective p-1 text-gray-400 hover:text-red-500 transition-colors" data-id="${obj.id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button></div>`;
                    DOM.objectivesContainer.appendChild(card);
                });
            };
            const renderPlaifMatrix = (plan) => {
                DOM.plaifGridContainer.innerHTML = ''; DOM.svgOverlay.innerHTML = '';
                DOM.plaifGridContainer.style.gridTemplateColumns = `150px repeat(${plan.duration}, minmax(120px, 1fr))`;
                DOM.plaifGridContainer.innerHTML += `<div class="plaif-header"></div>`;
                for (let i = 1; i <= plan.duration; i++) { const unitLabel = plan.unit.charAt(0).toUpperCase() + plan.unit.slice(1,-1); DOM.plaifGridContainer.innerHTML += `<div class="plaif-header">${unitLabel} ${i}</div>`; }
                CATEGORIES_ORDER.slice().reverse().forEach(category => {
                    const categoryLabel = category.charAt(0).toUpperCase() + category.slice(1); let rowHtml = `<div class="plaif-category">${categoryLabel}</div>`;
                    for(let i = 1; i <= plan.duration; i++){ const objectivesInCell = state.objectives.filter(obj => obj.planId === plan.id && obj.category === category && obj.timeUnitValue === i); let objectivesHtml = objectivesInCell.map(obj => `<div class="objective-pill ${CATEGORY_STYLES[obj.category.toLowerCase()] || 'bg-gray-600'}" data-id="${obj.id}">${obj.title}</div>`).join(''); rowHtml += `<div class="plaif-cell">${objectivesHtml}</div>`; }
                    DOM.plaifGridContainer.innerHTML += rowHtml;
                });
                setTimeout(() => drawConnectionLines(plan), 50);
            };
            const drawConnectionLines = (plan) => {
                DOM.svgOverlay.innerHTML = ''; const sortedObjectives = state.objectives.filter(obj => obj.planId === plan.id).sort((a, b) => a.order - b.order); if (sortedObjectives.length < 2) return;
                const matrixRect = DOM.plaifMatrixView.getBoundingClientRect();
                for(let i = 1; i < sortedObjectives.length; i++) {
                    const prevPill = document.querySelector(`.objective-pill[data-id="${sortedObjectives[i - 1].id}"]`), currentPill = document.querySelector(`.objective-pill[data-id="${sortedObjectives[i].id}"]`);
                    if(prevPill && currentPill) {
                        const prevRect = prevPill.getBoundingClientRect(), currentRect = currentPill.getBoundingClientRect();
                        const x1 = prevRect.left + prevRect.width / 2 - matrixRect.left + DOM.plaifMatrixView.scrollLeft, y1 = prevRect.top + prevRect.height / 2 - matrixRect.top + DOM.plaifMatrixView.scrollTop, x2 = currentRect.left + currentRect.width / 2 - matrixRect.left + DOM.plaifMatrixView.scrollLeft, y2 = currentRect.top + currentRect.height / 2 - matrixRect.top + DOM.plaifMatrixView.scrollTop;
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', x1); line.setAttribute('y1', y1); line.setAttribute('x2', x2); line.setAttribute('y2', y2);
                        line.setAttribute('stroke', 'rgba(156, 163, 175, 0.5)'); line.setAttribute('stroke-width', '2'); line.setAttribute('stroke-dasharray', '5,5');
                        DOM.svgOverlay.appendChild(line);
                    }
                }
                DOM.svgOverlay.setAttribute('width', DOM.plaifGridContainer.scrollWidth); DOM.svgOverlay.setAttribute('height', DOM.plaifGridContainer.scrollHeight);
            };
            const renderRadarChart = (plan) => {
                const ctx = document.getElementById('radar-chart-canvas').getContext('2d'); if (radarChartInstance) radarChartInstance.destroy();
                const labels = CATEGORIES_ORDER.map(c => c.charAt(0).toUpperCase() + c.slice(1));
                const dataCounts = CATEGORIES_ORDER.map(category => state.objectives.filter(obj => obj.planId === plan.id && obj.category === category).length);
                radarChartInstance = new Chart(ctx, {
                    type: 'radar', data: { labels: labels, datasets: [{ label: 'Nº de Objetivos', data: dataCounts, backgroundColor: 'rgba(139, 92, 246, 0.2)', borderColor: 'rgba(139, 92, 246, 1)', borderWidth: 2, pointBackgroundColor: 'rgba(139, 92, 246, 1)' }] },
                    options: { responsive: true, maintainAspectRatio: true, scales: { r: { beginAtZero: true, angleLines: { color: 'rgba(255, 255, 255, 0.2)' }, grid: { color: 'rgba(255, 255, 255, 0.2)' }, pointLabels: { color: '#E5E7EB', font: { size: 14 } }, ticks: { color: '#9CA3AF', backdropColor: 'rgba(0,0,0,0)', stepSize: 1 } } }, plugins: { legend: { labels: { color: '#E5E7EB' } } } }
                });
            };
            
            const navigateToPlan = (planId) => {
                state.currentPlanId = planId;
                const vizExists = state.visualizations.some(v => v.planId === planId);
                if (vizExists) {
                    state.currentPage = 'plan-detail';
                    state.detailViewMode = 'list';
                } else {
                    state.currentPage = 'visualization';
                }
                render();
            };
            const navigateToList = () => { state.currentPlanId = null; state.currentPage = 'plans-list'; render(); };
            const openModal = (modalElement) => modalElement.classList.remove('hidden');
            const closeModal = (modalElement) => modalElement.classList.add('hidden');
            const openObjectiveModal = (objectiveId = null, prefill = {}) => {
                DOM.formObjective.reset(); state.editingObjectiveId = objectiveId;
                const modalTitle = document.getElementById('modal-objective-title'), timeLabel = document.getElementById('objective-time-label'), timeInput = document.getElementById('objective-time-unit'), plan = state.plans.find(p => p.id === state.currentPlanId);
                const unitLabel = plan.unit.charAt(0).toUpperCase() + plan.unit.slice(1, -1);
                timeLabel.textContent = unitLabel; timeInput.setAttribute('max', plan.duration);
                if (objectiveId) {
                    modalTitle.textContent = "Editar Objetivo"; const objective = state.objectives.find(o => o.id === objectiveId);
                    document.getElementById('objective-title').value = objective.title; document.getElementById('objective-description').value = objective.description; document.getElementById('objective-category').value = objective.category; timeInput.value = objective.timeUnitValue;
                } else {
                     modalTitle.textContent = "Agregar Nuevo Objetivo"; document.getElementById('objective-title').value = prefill.title || ''; document.getElementById('objective-category').value = prefill.category || 'crecimiento personal';
                }
                openModal(DOM.modalObjective);
            }
            const openConfirmModal = (message, onConfirm) => { DOM.confirmMessage.textContent = message; state.confirmAction = onConfirm; openModal(DOM.modalConfirm); };
            
            // --- EVENT LISTENERS ---
            document.getElementById('btn-new-plan').addEventListener('click', () => openModal(DOM.modalPlan));
            document.getElementById('btn-create-first-plan').addEventListener('click', () => openModal(DOM.modalPlan));
            document.getElementById('btn-new-objective').addEventListener('click', () => openObjectiveModal());
            document.getElementById('btn-create-first-objective').addEventListener('click', () => openObjectiveModal());
            document.getElementById('btn-back-to-list-from-detail').addEventListener('click', navigateToList);
            DOM.btnViewList.addEventListener('click', () => { state.detailViewMode = 'list'; render(); });
            DOM.btnViewMatrix.addEventListener('click', () => { state.detailViewMode = 'matrix'; render(); });
            DOM.btnViewRadar.addEventListener('click', () => { state.detailViewMode = 'radar'; render(); });
            DOM.btnEditVisualization.addEventListener('click', () => { state.currentPage = 'visualization'; render(); });
            document.querySelectorAll('.btn-cancel-modal').forEach(btn => btn.addEventListener('click', (e) => { const modal = e.target.closest('.modal-enter'); if (modal) closeModal(modal); }));

            DOM.formPlan.addEventListener('submit', (e) => {
                e.preventDefault();
                const newPlanId = Date.now().toString();
                const planData = { id: newPlanId, name: document.getElementById('plan-name').value.trim(), duration: parseInt(document.getElementById('plan-duration').value, 10), unit: document.getElementById('plan-unit').value };
                state.plans.push(planData);
                saveState();
                closeModal(DOM.modalPlan);
                navigateToPlan(newPlanId);
            });

            DOM.formVisualization.addEventListener('submit', (e) => {
                e.preventDefault();
                const vizIndex = state.visualizations.findIndex(v => v.planId === state.currentPlanId);
                const vizData = { planId: state.currentPlanId, categories: {} };
                CATEGORIES_ORDER.forEach(category => {
                    const categoryId = category.replace(/\s+/g, '-');
                    const descElement = DOM.vizCategoriesContainer.querySelector(`#viz-desc-${categoryId}`);
                    const desc = descElement ? descElement.value : '';
                    const selectedButton = DOM.vizCategoriesContainer.querySelector(`[data-category="${category}"] .score-btn.selected`);
                    const score = selectedButton ? parseInt(selectedButton.dataset.score, 10) : 0;
                    vizData.categories[category] = { description: desc, score: score };
                });

                if (vizIndex > -1) { state.visualizations[vizIndex] = vizData; } 
                else { state.visualizations.push(vizData); }
                saveState();
                navigateToPlan(state.currentPlanId);
            });

             DOM.vizCategoriesContainer.addEventListener('click', e => {
                const scoreBtn = e.target.closest('.score-btn');
                if (scoreBtn) {
                    const parent = scoreBtn.parentElement;
                    parent.querySelectorAll('.score-btn').forEach(btn => btn.classList.remove('selected'));
                    scoreBtn.classList.add('selected');
                }
            });

            DOM.formObjective.addEventListener('submit', (e) => {
                e.preventDefault(); const currentObjectives = state.objectives.filter(o => o.planId === state.currentPlanId);
                const objectiveData = { id: state.editingObjectiveId || Date.now().toString(), planId: state.currentPlanId, title: document.getElementById('objective-title').value.trim(), description: document.getElementById('objective-description').value.trim(), category: document.getElementById('objective-category').value, timeUnitValue: parseInt(document.getElementById('objective-time-unit').value, 10), order: state.editingObjectiveId ? state.objectives.find(o=>o.id === state.editingObjectiveId).order : currentObjectives.length };
                if (state.editingObjectiveId) state.objectives = state.objectives.map(o => o.id === state.editingObjectiveId ? objectiveData : o); else state.objectives.push(objectiveData);
                state.editingObjectiveId = null; saveState(); render(); closeModal(DOM.modalObjective);
            });
            DOM.objectivesContainer.addEventListener('click', (e) => {
                const editButton = e.target.closest('.btn-edit-objective'), deleteButton = e.target.closest('.btn-delete-objective');
                if (editButton) openObjectiveModal(editButton.dataset.id);
                if (deleteButton) { const objectiveId = deleteButton.dataset.id, objective = state.objectives.find(o => o.id === objectiveId); openConfirmModal(`¿Estás seguro de que quieres eliminar "${objective.title}"?`, () => { state.objectives = state.objectives.filter(o => o.id !== objectiveId); const remaining = state.objectives.filter(o => o.planId === state.currentPlanId).sort((a,b) => a.order - b.order); remaining.forEach((o, index) => { const originalObj = state.objectives.find(s_o => s_o.id === o.id); if(originalObj) originalObj.order = index; }); saveState(); render(); }); }
            });
            DOM.plaifGridContainer.addEventListener('click', (e) => { const pill = e.target.closest('.objective-pill'); if(pill) openObjectiveModal(pill.dataset.id); });
            document.getElementById('btn-cancel-confirm').addEventListener('click', () => closeModal(DOM.modalConfirm));
            DOM.btnDoConfirm.addEventListener('click', () => { if(typeof state.confirmAction === 'function') state.confirmAction(); state.confirmAction = null; closeModal(DOM.modalConfirm); });
            document.getElementById('btn-suggest-objectives').addEventListener('click', async () => {
                const plan = state.plans.find(p => p.id === state.currentPlanId); if(!plan) return;
                const viz = state.visualizations.find(v => v.planId === plan.id);
                let vizText = '';
                if(viz) { vizText = 'Basado en mi visualización:\n' + CATEGORIES_ORDER.map(cat => `${cat}: ${viz.categories[cat]?.description || '(sin describir)'}`).join('\n'); }
                const existingObjectives = state.objectives.filter(o => o.planId === plan.id).map(o => `- ${o.title} (${o.category})`).join('\n');
                const prompt = `Soy una persona planificando mi vida con una herramienta llamada PLAIF. Mi plan se llama "${plan.name}" y dura ${plan.duration} ${plan.unit}. ${vizText}\n\nYa tengo estos objetivos:\n${existingObjectives}\n\nSugiere 3 nuevos objetivos creativos y accionables que complementen mi plan y visualización. Formatea cada sugerencia estrictamente en una nueva línea como 'CATEGORÍA: TÍTULO DEL OBJETIVO'. Usa solo estas categorías: ${CATEGORIES_ORDER.join(', ')}.`;
                const result = await callGemini(prompt);
                if(result) {
                    DOM.suggestionsContent.innerHTML = ''; const suggestions = result.trim().split('\n').filter(s => s.includes(':'));
                    suggestions.forEach(s => {
                        const [category, title] = s.split(':').map(part => part.trim());
                        if (CATEGORIES_ORDER.includes(category.toLowerCase())) {
                            const suggestionEl = document.createElement('div'); suggestionEl.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center'; suggestionEl.innerHTML = `<div><span class="font-bold text-purple-300">${category}:</span> ${title}</div>`; const addButton = document.createElement('button'); addButton.className = 'bg-gray-600 hover:bg-gray-500 text-sm py-1 px-3 rounded-md'; addButton.textContent = 'Agregar';
                            addButton.onclick = () => { closeModal(DOM.modalSuggestions); openObjectiveModal(null, { title, category: category.toLowerCase() }); };
                            suggestionEl.appendChild(addButton); DOM.suggestionsContent.appendChild(suggestionEl);
                        }
                    });
                    openModal(DOM.modalSuggestions);
                }
            });
            document.getElementById('btn-deconstruct-objective').addEventListener('click', async () => {
                const titleInput = document.getElementById('objective-title'), descTextarea = document.getElementById('objective-description'), title = titleInput.value.trim(); if(!title) { alert("Por favor, escribe un título para el objetivo primero."); return; }
                const prompt = `Toma el siguiente título de objetivo: "${title}". Desglósalo en una descripción detallada que incluya 2 o 3 pasos concretos y accionables para lograrlo. La descripción debe ser motivadora y clara, lista para ser usada en un plan de vida.`;
                const result = await callGemini(prompt); if(result) { descTextarea.value = result.trim(); }
            });

            // --- DRAG & DROP ---
            let draggedElement = null;
            DOM.objectivesContainer.addEventListener('dragstart', e => { if (e.target.draggable) { draggedElement = e.target; setTimeout(() => draggedElement.classList.add('dragging'), 0); } });
            DOM.objectivesContainer.addEventListener('dragend', () => { if(draggedElement) draggedElement.classList.remove('dragging'); draggedElement = null; });
            DOM.objectivesContainer.addEventListener('dragover', e => { e.preventDefault(); const target = e.target.closest('[draggable="true"]'); if (target && target !== draggedElement) { const rect = target.getBoundingClientRect(); const nextSibling = (e.clientY - rect.top) / rect.height > 0.5 ? target.nextSibling : target; DOM.objectivesContainer.insertBefore(draggedElement, nextSibling); } });
            DOM.objectivesContainer.addEventListener('drop', e => { e.preventDefault(); if(draggedElement){ const newOrderIds = Array.from(DOM.objectivesContainer.querySelectorAll('[data-id]')).map(el => el.dataset.id); newOrderIds.forEach((id, index) => { const objective = state.objectives.find(o => o.id === id); if(objective) objective.order = index; }); saveState(); render(); } });
            window.addEventListener('resize', () => { if(state.currentPage === 'plan-detail') { renderPlanDetailPage(); } });
            loadState(); render();
        });
    </script>
</body>
</html>
